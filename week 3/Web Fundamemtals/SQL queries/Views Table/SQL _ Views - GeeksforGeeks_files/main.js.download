var htmlOriginal;
var htmlMem;
var cursorTimeline;

//////////////////////////////////////////////////////////////////////////////////
function onSplitFrames() {
    // -- called when splitting banner into frames
}

// INIT BANNER ----------------------------------
function init() {
    // Disable separate frames
    // separateFrames = function() {};

    setBannerSize();
    show(".scene");
    show(".common");
    set(".htmlMem", { skewX: 0.1, transformOrigin: "50% 50%" });

    new ImagePreloader(
        ["frame1-text.png", "frame2-text.png", "frame3-text.png"],
        frame0
    );

    set('.cursor .line', {drawSVG: "0% 0%", display: "none"})

    htmlOriginal = $("body").innerHTML;
    htmlMem = $(".htmlMem").innerHTML;

    addListeners();
}

function frame0() {
    show(".banner");
    from(".htmlMem", 0.25, { opacity: 0 }, "in", 0);
    frame1();

    // cursor slides in
    cursorTimeline = new TimelineMax({ paused: true })
        .from('.cursor', 0.5, { x: 300, ease: Power2.easeOut})
        .from('.cursor', 0.7, { rotation: -90, ease: Back.easeOut}, 0.2)
        .to('.cursor .line', 0.2, { display: "", drawSVG: "30% 70%", ease: Linear.easeOut}, 1.2)
        .to('.cursor .line', 0.2, { drawSVG: "100% 100%", ease: Power2.easeOut}, 1.4)
        .to('.cursor', 0.2, { scale: 0.7, transformOrigin: "50% 50%", ease: Power3.easeOut}, 1.2)
        .to('.cursor', 0.2, { scale: 1, transformOrigin: "50% 50%", ease: Power3.easeOut}, 1.3)
        .to('.cursor', 0.6, { y: 150, rotation: 90, ease: Power2.easeIn}, 1.5)
        .to('.cursor', 0.6, { x: 150, ease: Sine.easeIn}, 1.5)
        .set('.cursor .line', {drawSVG: "0% 0%"})
}

function frame1() {
    show(".frame1");
    from(".frame1", 0.4, { opacity: 0, y: -20 }, "out", 0.1);

    var coffee = new TimelineMax({ delay: 0.4 })
        // show coffee    
        .from(".coffee", 0.1, {transformOrigin: "50% 50%", scale: 0, ease: Power2.easeOut}, 0)
        .from(".coffee #top", 0.5, {y: 30, ease: Back.easeOut}, 0)
        .from(".coffee #bottom", 0.5, {y: -30, ease: Back.easeOut}, 0)
        .from(".coffee #body", 0.5, {scaleY: 0, transformOrigin: "50% 50%", ease: Back.easeOut}, 0)
        .from(".coffee #cup", 0.2, {display: "none", transformOrigin: "50% 100%", y: -45, ease: Linear.easeNone}, "-=0.1")
        .from(".coffee #cup", 0.7, {rotation: -15, ease: Elastic.easeOut})
        // pour coffee
        .from(".coffee #head, .coffee #handle", 0.4, {display: "none", y: -15, ease: Power2.easeOut}, "-=0.7")
        .from(".coffee #stream", 0.4, {display: "none", y: -20, ease: Power2.easeOut}, "-=0.3")
        .from(".coffee #pointer", 1.0, {transformOrigin: "50% 50%", rotation: -70, ease: Linear.easeNone}, "-=1.0")

        // hide coffee
        .to(".coffee", 0.5, {scale: 0, ease: Back.easeIn}, 1.6)

    var tv = new TimelineMax({ delay: 0 })
        // show tv    
        .from(".tv #screen-yellow", 0.45, {transformOrigin: "50% 50%", scaleX: 0, ease: Power2.easeInOut}, 0)
        .from(".tv #screen-white", 0.45, {transformOrigin: "50% 50%", scaleX: 0, ease: Power2.easeInOut}, 0.15)
        .from(".tv #screen-yellow", 0.45, {scaleY: 0.07, ease: Power2.easeIn}, 0.2)
        .from(".tv #screen-white", 0.45, {scaleY: 0.05, ease: Power2.easeIn}, 0.25)
        .from(".tv #legs", 0.3, {display: "none", transformOrigin: "50% 50%", scale: 0.8, y: -25, ease: Power2.easeOut})
        .from(".tv #tv-button", 0.3, {display: "none", transformOrigin: "50% 50%", scale: 0, ease: Power2.easeOut}, "-=0.2")
        .staggerFrom(".tv #gloss path", 0.3, {drawSVG: "0% 0%", ease: Power2.easeOut}, 0.03, "-=0.4")
        
        // hide tv
        .staggerTo(".tv #gloss path", 0.3, {drawSVG: "100% 100%", ease: Power2.easeIn}, 0.03, 1.8)
        .to(".tv #legs", 0.3, {display: "none", scale: 0, y: -25, ease: Power2.easeIn}, "-=0.3")
        .to(".tv #tv-button", 0.3, {display: "none", scale: 0, ease: Power2.easeIn}, "-=0.3")
        .to(".tv #screen-yellow", 0.5, {scaleY: 0.07,  ease: Power2.easeInOut}, "-=0.2")
        .to(".tv #screen-white", 0.5, {scaleY: 0.05, ease: Power2.easeInOut}, "-=0.5")
        .to(".tv #screen-yellow", 0.5, {scaleX: 0, ease: Power2.easeIn}, "-=0.5")
        .to(".tv #screen-white", 0.5, {scaleX: 0, ease: Power2.easeIn}, "-=0.5")
        .to(".tv", 0.5, {x: 40, y: -20, ease: Power2.easeIn}, "-=0.5")

    wait(2.5, frame2);
}

function frame2() {
    show(".frame2");
    from(".frame2 .text", 0.4, { opacity: 0, y: -20 }, "out", 1.0);
    to(".frame1", 0.4, { opacity: 0, y: 20 }, "in", 0.25);

    set('.frame2 .cta', { display: "none" })

    var timeline = new TimelineMax({ delay: 0 })
        // show button
        .set('.frame2 .cta', { display: "" })
        .from('.frame2 .cta', 0.3, { scale: 0.8, ease: Back.easeOut })
        .from('.frame2 .cta', 0.5, { x: 101, width: 38, ease: Power2.easeOut }, "-=0.3")
        .from('.frame2 .cta img', 0.25, { opacity: 0, ease: Power2.easeIn }, "-=0.2")
        // press button animation
        .to('.frame2 .cta', 0.1, { scale: 0.8, ease: Power2.easeOut }, 2.75)
        .to('.frame2 .cta', 0.1, { scale: 1, ease: Power2.easeOut })
    
    wait(1.5, function(){ 
        cursorTimeline.play();
    })

        

    wait(2.6, frame3);
}

function frame3() {
    show(".frame3");
    from(".frame3 .text", 0.4, { opacity: 0, y: -20 }, "out", 0.5);
    to(".frame2 .text", 0.4, { opacity: 0, y: 20 }, "in");

    var timeline = new TimelineMax({ delay: 0.5 });
    timeline.to('.frame2 .cta', 0.5, { rotationX: -90, ease: Power2.easeIn })
        .from('.frame3 .cta', 0.5, { rotationX: 90, ease: Power2.easeOut })
        .from('.frame3 .logo', 0.5, { opacity: 0, ease: Power2.easeIn }, "-=0.5")


    if (banner.loopCount < 1) {
        banner.loopCount++;
        wait(5, loop);
    } else {
        from(".replay", 0.5, { opacity: 0 }, "in", 1);
    }
}

function loop() {
    killAll();
    to(".htmlMem", 1.0, { opacity: 0 }, "in");
    set(".replay", { display: "none", opacity: 1 });

    banner.looping = true;

    wait(1.0, function () {
        killAll();
        set(".htmlMem", { opacity: 1 });
        $(".htmlMem").innerHTML = htmlMem;
        frame0();
        banner.looping = false;
    });
}

function reset() {
    loop();
}

window.addEventListener("load", init);
